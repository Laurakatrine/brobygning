<!DOCTYPE html>
<html>

<head>
    <title></title>
</head>
<script src="/javascripts/jquery.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
    $(document).ready(function() {
        
        $("#navbar").load("navbar.html");
        $("#ekstraNav").load("navbarEkstra.html");
        $("footer").load("footer.html");
        
        var files = [];
        var chunks = [];

        var buttonPressed = false;
        var fotoData;
        var nr = 0;
        var lastChunckName;
        var fotoArray = [];
        var numArray = []; 
        
        localStorage.setItem("her", "seindlæg");
 
      
        
        let socket = io.connect('/'); // default namespace for Socket.io

        socket.emit("readyLoad");

        console.log("button: " + buttonPressed);
        $.get('/chunks', function(data) {
            for (i = 0; i < data.length; i++) {
                chunks.push(data[i]);
            }
        }).done(function() {
            $.get('/files', function(data) {
                for (i = 0; i < data.length; i++) {
                    files.push(data[i]);
                }

                for (j = 0; j < files.length; j++) {
                    for (i = 0; i < chunks.length; i++) {
                        if (chunks[i].files_id == files[j].id) {
                            if (lastChunckName == chunks[i].files_id) {
                                fotoArray[chunks[i].nr] = chunks[i].data;
                            } else {
                                lastChunckName = chunks[i].files_id;
                                fotoArray[chunks[i].nr] = chunks[i].data;
                            }

                        }

                        $('#fotos').append($(document.createElement('img')).prop({
                            id: 'foto' + (j)
                        }));

                        fotoData = "";

                        for (k = 0; k < fotoArray.length; k++) {
                            fotoData += fotoArray[k];

                        }


                        $('#foto' + (j)).attr("src", "data:image/" + files[j].type + ";base64," + fotoData);
                    }
                }

            });
        });



        $(function() {
            if (localStorage.getItem("login") == "false") {
                console.log("im not logged in");

                //$('#indhold').hide();
            }
            if (localStorage.getItem("login") == "true") {
                console.log("im already logged in");
                //$('#indhold').show();
            }

            socket.on("saved", (data) => {
                console.log("saved " + data);
                $('#titel').text("");
                var dataObj = JSON.parse(data);


                for (i = 0; i < dataObj.length; i++) {
                    
                    if(dataObj[i].brugernavn == localStorage.getItem("gruppenavn")){
                        numArray.push(i);
                    $('#content').append($(document.createElement('p')).prop({
                        id: 'dato'+i
                    }).html(dataObj[i].dato + ", " +dataObj[i].tidspunkt));
        /*                
                        
                    $('#content').append($(document.createElement('h3')).prop({
                        id: 'titel'+i
                    }).html(dataObj[i].titel ));
                        
                        
                        
                    $('#content').append($(document.createElement('p')).prop({
                        id: 'indhold'+i
                    }).html(dataObj[i].indlæg));
                    $('#content').append($(document.createElement('hr')));
                        
                   */ 
                   
                    $('#content').append($(document.createElement('form')).prop({
                        id: 'form'+i
                    }));    
                    
                        
                    $('#content').append($(document.createElement('textarea')).prop({
                        
                        id: 'titel'+i,
                        class: 'contentform',
                        cols: "160",
                        readonly: true
                        
                    }).html(dataObj[i].titel)); 
                       
                        
                   /*     $('#content').append($(document.createElement('button')).prop({
                        
                        id: 'send'+i,
                        type: "button"
                        
                    }).html("upload")); 
                        */
               
                        
                        
                    $('#content').append($(document.createElement('textarea')).prop({
                        
                        id: 'input'+i,
                        class: 'contentform',
                        cols: "160",
                        rows: "30",
                        
                        //readonly: true
                        
                    }).html(dataObj[i].indlæg));
                          
                        
                        
                     /*   $('#content').append($(document.createElement('button')).prop({
                        
                        //form: "form" + i, 
                        id: "button" + i, 
                        type: "button"
                    }).html("change"));*/
                        
                        
                        
                       
                }
                    }
                
            
          

        
        });
        
       /* 
          
          console.log(numArray);
              for(i=0; i<numArray.length; i++)
            {
                console.log(numArray[i]);
                var num = numArray[i]
                  $("#send" + num).on('click', function () {
             console.log("clikked");
          
                var username = localStorage.getItem("gruppenavn");
                var data = $('#input' + num).val();
                var titel = $('#titel' + num).val();
                console.log(data);
                console.log(username);

                if (titel.length == 0) {
                    alert("Du skal give indholdet en titel");
                } else {
                    socket.emit('edit', data, username, titel);
                    console.log(data, username, titel);
                    $('#input').val('');
                    $('#inputTitel').val('');

                    $('#input').text("");
                    $('#inputTitel').text("");
                    alert("Indlægget er lagt op!");
                }
                console.log(titel.length);
            
            
            
            
        });
            }*/

            });
     
       
        // vi lader som om at knap send0 virker
        //lige nu ændre den tidspunktet på alle indlæg overvej om det skal ændres 
        $("#testbutton").on('click', function () {
             console.log("clikked");
            
            
             for(i=0; i<numArray.length; i++)
            {
                var num = numArray[i]
                var username = localStorage.getItem("gruppenavn");
                var data = $('#input' + num).val();
                var titel = $('#titel' + num).val();
                console.log(data);
                console.log(username);

                    socket.emit('edit', data, username, titel);
                    console.log(data, username, titel);
                    
                }
                console.log(titel.length);
            
                            
             alert("opdateret!");               
            
            /*
            var num = 0
                var username = localStorage.getItem("gruppenavn");
                var data = $('#input' + 0).val();
                var titel = $('#titel' + 0).val();
                console.log(data);
                console.log(username);

                if (titel.length == 0) {
                    alert("Du skal give indholdet en titel");
                } else {
                    socket.emit('edit', data, username, titel);
                    console.log(data, username, titel);
                    $('#input').val('');
                    $('#inputTitel').val('');

                    $('#input').text("");
                    $('#inputTitel').text("");
                    alert("Indlægget er lagt op!");
                }
                console.log(titel.length);
           
            
            */
            
        });
        
    
   
    
    
    });

</script>

<body>
    <div id="navbar">

    </div>
    
    <div id="ekstraNav">
    </div>
    <div id="beskrivelse">
    <div>
    <h2>Se indlæg</h2>
   <!-- <p>Her kan du se alle indlæg der er lagt op.</p>-->
        <p>Billeder er langsomme om at loade, vær tålmodig og de kommer :-). </p>

    </div>

    <div>
        <div id="fotos">
        </div>
        <img id="foto">


    </div>
    <div id="content">
        <div>
            <p id="dato"></p>
        </div>
    <div>
        <h3 id=titel></h3>
    </div>
    <div>
        <p id="indhold"></p>
    </div>
        
        <button id="testbutton" type="button"> Opdater indlæg</button>

</div>
        </div>



</body>
<footer></footer>

</html>
